name: Codacy Coverage All Services
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  coverage:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      
    # Auth Service
    - name: Test Auth Service
      working-directory: ./auth-service
      run: |
        npm ci
        npm test -- --coverage
    
    - name: Upload Auth Coverage to Codacy
      env:
        CODACY_API_TOKEN: ${{ secrets.CODACY_API_TOKEN }}
        CODACY_ORGANIZATION_PROVIDER: gh
        CODACY_USERNAME: Beebboop
        CODACY_PROJECT_NAME: Workflow-App
      working-directory: ./auth-service
      run: |
        bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
          -r coverage/lcov.info \
          --force-language typescript
    
    # Task Service
    - name: Test Task Service
      working-directory: ./task-service
      continue-on-error: true
      run: |
        npm ci
        npm test -- --coverage
    
    - name: Upload Task Coverage to Codacy
      if: always()
      env:
        CODACY_API_TOKEN: ${{ secrets.CODACY_API_TOKEN }}
        CODACY_ORGANIZATION_PROVIDER: gh
        CODACY_USERNAME: Beebboop
        CODACY_PROJECT_NAME: Workflow-App
      working-directory: ./task-service
      run: |
        bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
          -r coverage/lcov.info \
          --force-language typescript