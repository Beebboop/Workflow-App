name: Codacy Coverage All Services
on:
  push:
    branches: [ main ]

jobs:
  coverage:
    runs-on: ubuntu-latest
    environment: main
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    # Auth Service
    - name: Test auth-service
      working-directory: ./auth-service
      run: |
        npm ci
        npm run test:cov 2>/dev/null || npm test -- --coverage
        
    - name: Verify auth-service coverage file
      working-directory: ./auth-service
      run: |
        if [ -f "coverage/lcov.info" ]; then
          echo "coverage/lcov.info exists"
          if [ -s "coverage/lcov.info" ]; then
            echo "File is not empty"
          fi
        else
          echo "coverage/lcov.info not found"
          exit 1
        fi
        
    - name: Upload auth-service coverage
      env:
        CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
      run: |
        bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
          -r auth-service/coverage/lcov.info \
          -t "$CODACY_PROJECT_TOKEN"
        
        echo "Auth service coverage uploaded"
        
    # Task Service
    - name: Check if task-service exists
      id: check-task
      run: |
        if [ -d "task-service" ] && [ -f "task-service/package.json" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Test task-service
      if: steps.check-task.outputs.exists == 'true'
      working-directory: ./task-service
      run: |
        npm ci
        npm run test:cov 2>/dev/null || npm test -- --coverage || echo "No tests found"
        
    - name: Upload task-service coverage
      if: steps.check-task.outputs.exists == 'true'
      env:
        CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
      run: |

        if [ -f "task-service/coverage/lcov.info" ]; then
          export CODACY_PROJECT_TOKEN="${{ secrets.CODACY_PROJECT_TOKEN }}"
          bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
            -r task-service/coverage/lcov.info
          echo "Task service coverage uploaded"
        else
          echo "No coverage file for task-service, skipping"
        fi