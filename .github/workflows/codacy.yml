name: Codacy Coverage All Services
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  coverage:
    runs-on: ubuntu-latest
    environment: main
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    # Auth Service Coverage
    - name: Setup Node.js for Auth Service
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: auth-service/package-lock.json
    
    - name: Install dependencies for Auth Service
      working-directory: ./auth-service
      run: npm ci --no-audit
    
    - name: Generate coverage for Auth Service
      working-directory: ./auth-service
      run: |
        # Запускаем тесты с coverage
        npm test -- --coverage --passWithNoTests
        
        # Проверяем где создался coverage
        echo "=== Auth Service Coverage Files ==="
        find . -name "lcov.info" -type f | grep -v node_modules
        
        # Копируем coverage в корень если он в src/fuzz
        if [ -f "src/fuzz/coverage/lcov.info" ] && [ ! -f "coverage/lcov.info" ]; then
          mkdir -p coverage
          cp src/fuzz/coverage/lcov.info coverage/lcov.info
          echo " Copied coverage from src/fuzz/coverage/lcov.info"
        fi
    
    - name: Upload Auth Service coverage to Codacy
      env:
        CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
      working-directory: ./auth-service
      run: |
        if [ -f "src/fuzz/coverage/lcov.info" ] && [ -s "src/fuzz/coverage/lcov.info" ]; then
          echo "Uploading auth-service coverage to Codacy..."
          bash <(curl -Ls https://coverage.codacy.com/get.sh) report -r src/fuzz/coverage/lcov.info -t $CODACY_PROJECT_TOKEN
          echo " Auth service coverage uploaded to Codacy"
        else
          echo " No coverage file found for auth-service"
          echo "Creating empty coverage for debugging..."
          mkdir -p coverage
          echo "TN:" > coverage/lcov.info
          echo "end_of_record" >> coverage/lcov.info
          bash <(curl -Ls https://coverage.codacy.com/get.sh) report -r coverage/lcov.info -t $CODACY_PROJECT_TOKEN
        fi
        
    # Task Service Coverage
    - name: Check if task-service exists
      id: check-task
      run: |
        if [ -d "task-service" ] && [ -f "task-service/package.json" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Setup Node.js for Task Service
      if: steps.check-task.outputs.exists == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: task-service/package-lock.json
    
    - name: Install dependencies for Task Service
      if: steps.check-task.outputs.exists == 'true'
      working-directory: ./task-service
      run: npm ci --no-audit
    
    - name: Generate coverage for Task Service
      if: steps.check-task.outputs.exists == 'true'
      working-directory: ./task-service
      run: |
        # Запускаем тесты с coverage 
        npm test -- --coverage --passWithNoTests || true
        
        echo "=== Task Service Coverage Files ==="
        find . -name "lcov.info" -type f | grep -v node_modules
        
        # Если coverage нет, создаем минимальный
        if [ ! -f "src/fuzz/coverage/lcov.info" ]; then
          echo "  No coverage file found, creating minimal one"
          mkdir -p src/fuzz/coverage
          echo "TN:" > src/fuzz/coverage/lcov.info
          echo "end_of_record" >> src/fuzz/coverage/lcov.info
        fi
    
    - name: Upload Task Service coverage to Codacy
      if: steps.check-task.outputs.exists == 'true'
      env:
        CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
      working-directory: ./task-service
      run: |
        if [ -f "src/fuzz/coverage/lcov.info" ]; then
          echo "Uploading task-service coverage to Codacy..."
          bash <(curl -Ls https://coverage.codacy.com/get.sh) report -r src/fuzz/coverage/lcov.info -t $CODACY_PROJECT_TOKEN
          echo " Task service coverage uploaded to Codacy"
        else
          echo " No coverage file found for task-service"
        fi